kind: pipeline
name: default

steps:
- name: build-composer
  image: composer
  commands:
  - composer install --ignore-platform-reqs --no-scripts
- name: test
  image: lanopsdev/base-ci:latest
  # privileged: true
  volumes:
  - name: docker-socket
    path: /var/run/docker.sock
  commands:
  - ls
  # - apk add make
  - make app-build-docker
  - docker run -d lanopsdev/manager:ci-test
  - make database-migrate database-seed generate-key
  - make stop
  when:
    event:
    - push
services:
- name: database
  image: mysql:5.6
  environment:
    MYSQL_DATABASE: lan_manager
    MYSQL_USER: lan_manager
    MYSQL_PASSWORD: password
    MYSQL_RANDOM_ROOT_PASSWORD: true

volumes:
- name: docker-socket
  host:
    path: /var/run/docker.sock