kind: pipeline
name: default

steps:
- name: build-composer
  image: composer
  commands:
  - cd src/
  - composer install --ignore-platform-reqs --no-scripts
  when:
    event:
    - push
- name: build-npm
  image: node:8
  commands:
  - cd src/
  - npm install && node_modules/.bin/gulp --production
  when:
    event:
    - push
- name: build-structure
  image: alpine:3.8
  commands:
  - apk add make
  - make folder-structure layout-images env-file
  when:
    event:
    - push
- name: build-image  
  image: plugins/docker
  settings:
    repo: lanopsdev/manage
    tags: ci-test
    dry_run: true
# - name: build-image
#   image: docker:18.06.2-ce-dind
#   # privileged: true
#   volumes:
#   - name: docker-socket
#     path: /var/run/docker.sock
#   commands:
#   - apk add make
#   - make folder-structure layout-images env-file
#   - docker build -t lanopsdev/manager:ci-test .
#   - docker run -d lanopsdev/manager:ci-test
#   - make database-migrate database-seed generate-key
#   - make stop
  when:
    event:
    - push
services:
- name: database
  image: mysql:5.6
  environment:
    MYSQL_DATABASE: lan_manager
    MYSQL_USER: lan_manager
    MYSQL_PASSWORD: password
    MYSQL_RANDOM_ROOT_PASSWORD: true

volumes:
- name: docker-socket
  host:
    path: /var/run/docker.sock